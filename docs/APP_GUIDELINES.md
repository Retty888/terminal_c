# Руководство по работе приложения (соглашения и инварианты)

Этот документ фиксирует важные принципы и ожидания, чтобы изменения не ломали ключевое поведение.

## Загрузка данных и история свечей

- Исторические данные: при старте загружаются сохранённые свечи для выбранных пар/интервалов, затем недостающее догружается по HTTP пакетами.
- `candles_limit`: целевой размер истории на активном интервале. Инвариант — 5000 по умолчанию.
  - Значение читается из `config.json`. Если потребуется меньше — это осознанное изменение конфигурации, но не кода.
  - Если локальные CSV повреждены (несогласованные таймстемпы) — они исправляются/перезагружаются через `fetch_range`, при необходимости — полная очистка и повторная загрузка.
- Источники данных: HTTP-запросы обслуживает Hyperliquid. `primary_provider` по умолчанию `hyperliquid` (регистр значения неважен) и выбирается при старте из `config.json`. `fallback_provider` можно указать строкой (резервный источник) либо отключить (`null`, `false`, пустая строка) — тогда приложение работает только с Hyperliquid. Поддержка старых названий (`binance`, `gateio`) сохранена на случай возврата централизованных бирж.
- Ограничения Hyperliquid: публичное API не отдаёт полный список символов и поддерживает ограниченный набор интервалов (`1m`, `5m`, `15m`, `1h`, `4h`, `1d`). Используется curated список топовых USDT-пар.
- Лимит и пакетная догрузка: запросы не превышают лимиты API; используется троттлинг (rate limiter) и экспоненциальная пауза при ошибках.

## Реальный стрим и обновление графика

- Hyperliquid не предоставляет публичный kline WebSocket, поэтому даже при `enable_streaming: true` данные обновляются через HTTP-поллинг. Реализация стрима для Binance/GateIO оставлена в коде, чтобы переключение работало сразу после возврата этих провайдеров.
- При указании в конфиге провайдера без поддержки WS приложение логирует предупреждение и не запускает стрим.
- При ошибках стрима выполняется реконнект с бэкоффом без блокировки UI.

## WebView/TradingView

- Инициализация графика через handshake: JS вызывает `appReady('ok')`, после чего приложение отправляет:
  - `series.setData([...])` с историей свечей
  - `setIntervals([...])` и `setActiveInterval()`
  - активный тип серии и инструмент
- HTML и ресурсы: `resources/chart.html`, `lightweight-charts.standalone.production.js`.
  - На Windows встраивание WebView2 внутри окна GLFW.

## Конфигурация и окружение

- Путь до конфига задаётся `CANDLE_CONFIG_PATH`. Если не задан — ищется рядом с exe.
- Важные поля `config.json`:
  - `candles_limit`: по умолчанию 5000, не понижать в коде.
  - `primary_provider`: `hyperliquid` по умолчанию; значение читается без учёта регистра. Исторические названия `binance`/`gateio` остаются для обратной совместимости.
  - `fallback_provider`: строка с резервным провайдером либо `null`/`false`/пустая строка для отключения.
  - `enable_streaming`: флаг оставлен для будущего возврата Binance/GateIO; с Hyperliquid работает только HTTP.
  - `data_dir`: директория хранения CSV (`candle_data`).
- Переменные окружения (для диагностики/отладки):
  - `CANDLE_DISABLE_WEBVIEW` — отключить встраиваемый WebView (откат к ImPlot).
  - `CANDLE_WEBVIEW_EXTERNAL` — открывать WebView как отдельное окно.
  - `CANDLE_FETCH_CHUNK` — переопределить размер пакета загрузки свечей.

## Логи и диагностика

- Лог `terminal.log` включает этапы инициализации (GLFW, окно, ImGui, загрузка конфигурации), а также события WebSocket (open/error/close).
- Уровень логирования и вывод (файл/консоль) задаются в `config.json`.

## Сборка и зависимости

- Используем `vcpkg` и `CMakePresets.json`:
  - `cmake --preset default-vcpkg-Release`
  - `cmake --build --preset build-rel`
  - `ctest --preset test-rel --output-on-failure`
- Windows: требуется Microsoft Edge WebView2 Runtime.

## Принципы изменения кода

- Нельзя понижать дефолты критичных параметров (например, `candles_limit`) без явного изменения `config.json` и обновления этого документа.
- Любое изменение поведения стрима/графика должно сохранять совместимость с существующими конфигами и сценариями.
- Перед мёрджем — запуск тестов (Release) и ручная проверка старта приложения с дефолтным конфигом.

## Чек‑лист при изменениях, затрагивающих график/данные

1) Проверить `candles_limit` = 5000 (если иное — это изменение продукта, а не кода).
2) Запуск с дефолтным `primary_provider: hyperliquid` (HTTP-поллинг). Убедиться, что история догружается и в логах нет неожиданностей. При возврате Binance восстановить проверку стрима.
3) Повреждённые CSV корректно чинятся/перезагружаются; график не остаётся пустым.
4) WebView инициализируется только после `appReady`; нет гонок.
5) Логи содержат `WS open`/`WS close`/`WS error` для диагностики.

