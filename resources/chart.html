<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ECharts</title>
  <script src="../third_party/echarts/echarts.min.js"></script>
  <style>
    html, body, #chart { height:100%; width:100%; margin:0; }
  </style>
</head>
<body>
  <select id="interval">
    <option value="1m">1m</option>
    <option value="5m">5m</option>
    <option value="1h">1h</option>
  </select>
  <div id="chart" style="height:90%;"></div>
  <script>
    const chart = echarts.init(document.getElementById('chart'));
    const intervalSel = document.getElementById('interval');
    intervalSel.addEventListener('change', function() {
      sendToCpp({ interval: intervalSel.value });
    });
    chart.setOption({
      title: { text: 'ECharts' },
      xAxis: { type: 'category', data: [] },
      yAxis: { scale: true },
      series: [
        {
          name: 'Candlestick',
          type: 'candlestick',
          itemStyle: {
            color: '#0CF49B',
            color0: '#FD1050',
            borderColor: '#0CF49B',
            borderColor0: '#FD1050'
          },
          data: []
        }
      ]
    });

    window.receiveFromCpp = function(obj) {
      try {
        if (Array.isArray(obj.x) && Array.isArray(obj.y)) {
          chart.setOption({
            xAxis: { data: obj.x },
            series: [{
              name: 'Candlestick',
              type: 'candlestick',
              data: obj.y
            }]
          });
        }
        if (obj.interval) {
          intervalSel.value = obj.interval;
        }
      } catch (e) {
        console.error('Invalid data from C++', e);
      }
    };

    function sendToCpp(obj) {
      if (window.bridge) {
        window.bridge(JSON.stringify(obj));
      }
    }

    window.onload = function() {
      sendToCpp({ request: 'init' });
    };
  </script>
</body>
</html>
