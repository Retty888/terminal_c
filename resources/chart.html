<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #container { position:relative; width:100%; height:100%; }
    #tvchart { width:100%; height:100%; }
    #toolbar { position:absolute; left:0; top:0; z-index:10; display:flex; flex-direction:column; }
    #toolbar button, #toolbar select { height:32px; margin:2px; background:#222; color:#fff; border:none; cursor:pointer; }
    #toolbar button { width:64px; }
    #toolbar button.active { background:#555; }
    #overlay { position:absolute; left:0; top:0; z-index:5; }
    #coords { position:absolute; right:0; bottom:0; z-index:10; background:#222; color:#fff; padding:2px 4px; font-family:monospace; }
  </style>
  <title>Chart</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob: file:; script-src 'self' 'unsafe-inline' file:;">
  </head>
<body>
<div id="container">
  <div id="toolbar">
    <select id="interval-select"></select>
    <select id="series-select">
      <option value="CandlestickSeries">CandlestickSeries</option>
      <option value="LineSeries">LineSeries</option>
      <option value="AreaSeries">AreaSeries</option>
    </select>
    <button id="fit-btn">Fit</button>
    <button id="tool-cross" data-tool="cross">Cross</button>
    <button id="tool-ruler" data-tool="ruler">Ruler</button>
    <button id="tool-trend" data-tool="trend">Trend</button>
    <button id="tool-long" data-tool="long">Long</button>
    <button id="tool-short" data-tool="short">Short</button>
    <button id="tool-fibo" data-tool="fibo">Fibo</button>
  </div>
  <div id="tvchart"></div>
  <canvas id="overlay"></canvas>
  <div id="coords"></div>
</div>
<script src="lightweight-charts.standalone.production.js"></script>
<script>
  const container = document.getElementById('container');
  const chartEl = document.getElementById('tvchart');
  const overlay = document.getElementById('overlay');
  const coordsEl = document.getElementById('coords');
  const intervalSelect = document.getElementById('interval-select');
  const seriesSelect = document.getElementById('series-select');

  const chart = LightweightCharts.createChart(chartEl, {
    width: container.clientWidth,
    height: container.clientHeight,
    timeScale: { timeVisible: true, secondsVisible: false }
  });
  let series = chart.addCandlestickSeries();
  let markers = [];
  let priceLine = null;
  const data = [];
  const ctx = overlay.getContext('2d');
  chart.subscribeCrosshairMove(param => {
    if (!param.time || !param.point) { coordsEl.textContent = ''; return; }
    const price = param.seriesPrices.get(series);
    const ts = (typeof param.time === 'object')
      ? `${param.time.year}-${param.time.month}-${param.time.day}`
      : new Date(param.time * 1000).toLocaleString();
    coordsEl.textContent = `${ts} ${price !== undefined ? price.toFixed(2) : ''}`;
  });

  function resize() {
    const w = container.clientWidth;
    const h = container.clientHeight;
    chart.applyOptions({ width: w, height: h });
    overlay.width = w; overlay.height = h;
    redraw();
  }
  window.addEventListener('resize', resize);
  resize();

  let currentTool = 'cross';
  let drawing = null;
  const drawings = [];
  const positions = [];
  let positionId = 0;

  function setActiveTool(t) {
    currentTool = t;
    document.querySelectorAll('#toolbar button[data-tool]').forEach(b => {
      b.classList.toggle('active', b.dataset.tool === t);
    });
    overlay.style.pointerEvents = (t === 'cross') ? 'none' : 'auto';
  }
  window.setActiveTool = setActiveTool;

  function selectTool(t) {
    setActiveTool(t);
    if (typeof setTool === 'function') setTool(t);
  }
  document.querySelectorAll('#toolbar button[data-tool]').forEach(b => {
    b.addEventListener('click', () => selectTool(b.dataset.tool));
  });

  document.getElementById('fit-btn').addEventListener('click', () => {
    chart.timeScale().fitContent();
    chart.timeScale().scrollToRealTime();
  });

  function createSeries(t) {
    if (series) chart.removeSeries(series);
    if (t === 'LineSeries') series = chart.addLineSeries();
    else if (t === 'AreaSeries') series = chart.addAreaSeries();
    else series = chart.addCandlestickSeries();
    series.setData(data);
    if (markers.length) series.setMarkers(markers);
    if (priceLine !== null) series.createPriceLine({ price: priceLine });
  }
  function setActiveSeries(t) { seriesSelect.value = t; createSeries(t); }
  window.setActiveSeries = setActiveSeries;
  function selectSeries(t) { setActiveSeries(t); if (typeof setSeries === 'function') setSeries(t); }
  seriesSelect.addEventListener('change', () => selectSeries(seriesSelect.value));

  // Interval change â†’ notify native side via bound function if present
  intervalSelect.addEventListener('change', () => {
    const iv = intervalSelect.value;
    if (typeof setInterval === 'function') setInterval(iv);
    if (typeof status === 'function') status('Interval: ' + iv);
  });

  // Allow native side to push intervals and active selection
  window.setIntervals = function(list) {
    const current = intervalSelect.value;
    intervalSelect.innerHTML = '';
    (list || []).forEach(iv => {
      const opt = document.createElement('option');
      opt.value = iv; opt.textContent = iv; intervalSelect.appendChild(opt);
    });
    if (current && list && list.includes(current)) intervalSelect.value = current;
  };
  window.setActiveInterval = function(iv) {
    if (!iv) return;
    intervalSelect.value = iv;
  };

  function redraw() {
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    drawings.forEach(d => {
      const x1 = chart.timeScale().timeToCoordinate(d.time1);
      const y1 = series.priceToCoordinate(d.price1);
      const x2 = chart.timeScale().timeToCoordinate(d.time2);
      const y2 = series.priceToCoordinate(d.price2);
      ctx.strokeStyle = 'yellow';
      ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    });
    positions.forEach(p => {
      const x1 = chart.timeScale().timeToCoordinate(p.time1);
      const y1 = series.priceToCoordinate(p.price1);
      const x2 = chart.timeScale().timeToCoordinate(p.time2);
      const y2 = series.priceToCoordinate(p.price2);
      ctx.fillStyle = p.tool === 'long' ? 'rgba(0,255,0,0.2)' : 'rgba(255,0,0,0.2)';
      ctx.strokeStyle = p.tool === 'long' ? 'green' : 'red';
      ctx.beginPath(); ctx.rect(x1, y1, x2 - x1, y2 - y1); ctx.fill(); ctx.stroke();
    });
  }

  overlay.addEventListener('mousedown', e => {
    if (currentTool === 'cross') return;
    const x = e.offsetX; const y = e.offsetY;
    drawing = { x1: x, y1: y, time1: chart.timeScale().coordinateToTime(x), price1: series.coordinateToPrice(y), tool: currentTool };
  });
  overlay.addEventListener('mousemove', e => {
    if (!drawing) return; redraw();
    const x = e.offsetX; const y = e.offsetY;
    ctx.strokeStyle = 'yellow'; ctx.beginPath(); ctx.moveTo(drawing.x1, drawing.y1); ctx.lineTo(x, y); ctx.stroke();
  });
  overlay.addEventListener('mouseup', e => {
    if (!drawing) return;
    const x = e.offsetX; const y = e.offsetY;
    drawing.x2 = x; drawing.y2 = y; drawing.time2 = chart.timeScale().coordinateToTime(x); drawing.price2 = series.coordinateToPrice(y);
    positions.push(drawing); drawing = null; redraw();
  });

  // API used by native side
  window.updateCandle = function(c) {
    if (data.length && data[data.length - 1].time === c.time) {
      data[data.length - 1] = c; series.update(c);
    } else { data.push(c); series.update(c); }
  };
  window.chart = {
    setMarkers: function(m) { markers = m; series.setMarkers(m); },
    setPriceLine: function(p) { priceLine = p; series.createPriceLine({ price: p }); }
  };
  window.addPosition = function(p) { p.id = p.id ?? (positionId++); positions.push(p); redraw(); return p.id; };
  window.removePosition = function(id) { const i = positions.findIndex(p => p.id === id); if (i !== -1) { positions.splice(i,1); redraw(); } };
  window.updatePosition = function(p) { const i = positions.findIndex(x => x.id === p.id); if (i !== -1) { positions[i] = { ...positions[i], ...p }; redraw(); } };
  window.getPositions = () => positions;
</script>
</body>
</html>
